<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Private Tweeter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 500px; margin: 20px auto; padding: 20px; background: #f5f8fa; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        textarea { width: 100%; height: 100px; border: 1px solid #ccd6dd; border-radius: 10px; padding: 10px; box-sizing: border-box; resize: none; margin-bottom: 10px; font-size: 16px; }
        button { background: #1da1f2; color: white; border: none; padding: 12px 24px; border-radius: 25px; cursor: pointer; font-weight: bold; width: 100%; }
        button:hover { background: #1a91da; }
        button:disabled { background: #ccc; }
        #status { margin-top: 15px; font-size: 0.9em; text-align: center; }
        .settings { margin-top: 30px; font-size: 0.8em; color: #657786; border-top: 1px solid #eee; padding-top: 10px; }
        .input-group { margin-bottom: 10px; }
        input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; margin-top: 4px; }
    </style>
</head>
<body>

<div class="card">
    <h2>ã„ã¾ã©ã†ã—ã¦ã‚‹ï¼Ÿ</h2>
    <textarea id="tweetText" placeholder="ã“ã“ã«å…¥åŠ›ã—ã¦ãƒ„ã‚¤ãƒ¼ãƒˆï¼"></textarea>
    <button id="postBtn" onclick="postTweet()">ãƒ„ã‚¤ãƒ¼ãƒˆã™ã‚‹</button>
    <p id="status"></p>

    <div class="settings">
        <h3>ğŸ”‘ APIè¨­å®š</h3>
        <div class="input-group">
            <label>API Key / Consumer Key</label>
            <input type="password" id="consumerKey">
        </div>
        <div class="input-group">
            <label>API Key Secret / Consumer Secret</label>
            <input type="password" id="consumerSecret">
        </div>
        <div class="input-group">
            <label>Access Token</label>
            <input type="password" id="accessToken">
        </div>
        <div class="input-group">
            <label>Access Token Secret</label>
            <input type="password" id="accessTokenSecret">
        </div>
        <button onclick="saveKeys()" style="background: #657786; margin-top: 10px;">è¨­å®šã‚’ä¿å­˜</button>
        
        <p style="margin-top:20px;">â€» CORSã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶æ‹¡å¼µæ©Ÿèƒ½ï¼ˆAllow CORSç­‰ï¼‰ã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚</p>
    </div>
</div>

<script>
    // ã‚­ãƒ¼ã®èª­ã¿è¾¼ã¿
    window.onload = () => {
        const keys = ['consumerKey', 'consumerSecret', 'accessToken', 'accessTokenSecret'];
        keys.forEach(k => document.getElementById(k).value = localStorage.getItem('x_' + k) || '');
    };

    function saveKeys() {
        const keys = ['consumerKey', 'consumerSecret', 'accessToken', 'accessTokenSecret'];
        keys.forEach(k => localStorage.setItem('x_' + k, document.getElementById(k).value));
        alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
    }

    // OAuth 1.0a ç½²åä½œæˆã®ç°¡æ˜“ãƒ­ã‚¸ãƒƒã‚¯
    function getAuthHeader(method, url, params) {
        const cKey = localStorage.getItem('x_consumerKey');
        const cSecret = localStorage.getItem('x_consumerSecret');
        const tKey = localStorage.getItem('x_accessToken');
        const tSecret = localStorage.getItem('x_accessTokenSecret');

        const oauthParams = {
            oauth_consumer_key: cKey,
            oauth_nonce: Math.random().toString(36).substring(2),
            oauth_signature_method: "HMAC-SHA1",
            oauth_timestamp: Math.floor(Date.now() / 1000),
            oauth_token: tKey,
            oauth_version: "1.0"
        };

        const allParams = { ...params, ...oauthParams };
        const baseString = method + "&" + encodeURIComponent(url) + "&" +
            encodeURIComponent(Object.keys(allParams).sort().map(k => `${k}=${allParams[k]}`).join("&"));
        const signingKey = encodeURIComponent(cSecret) + "&" + encodeURIComponent(tSecret);
        const signature = CryptoJS.HmacSHA1(baseString, signingKey).toString(CryptoJS.enc.Base64);

        oauthParams.oauth_signature = signature;
        return "OAuth " + Object.keys(oauthParams).map(k => `${k}="${encodeURIComponent(oauthParams[k])}"`).join(", ");
    }

    async function postTweet() {
        const text = document.getElementById('tweetText').value;
        const btn = document.getElementById('postBtn');
        const status = document.getElementById('status');

        if (!text) return alert('æ–‡å­—ã‚’å…¥åŠ›ã—ã¦ã­');
        
        btn.disabled = true;
        status.innerText = 'é€ä¿¡ä¸­...';

        const url = "https://api.twitter.com/2/tweets";
        const authHeader = getAuthHeader("POST", url, {});

        try {
            const response = await fetch(url, {
                method: "POST",
                headers: {
                    "Authorization": authHeader,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ text: text })
            });

            if (response.ok) {
                status.innerText = "âœ… ãƒ„ã‚¤ãƒ¼ãƒˆã—ã¾ã—ãŸï¼";
                document.getElementById('tweetText').value = "";
            } else {
                const err = await response.json();
                status.innerText = "âŒ ã‚¨ãƒ©ãƒ¼: " + (err.detail || response.statusText);
            }
        } catch (e) {
            status.innerText = "âŒ é€ä¿¡å¤±æ•—ã€‚CORSåˆ¶é™ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚";
            console.error(e);
        } finally {
            btn.disabled = false;
        }
    }
</script>
</body>
</html>