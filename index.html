<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Private Tweeter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; max-width: 500px; margin: 20px auto; padding: 20px; background: #f5f8fa; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        textarea { width: 100%; height: 120px; border: 1px solid #ccd6dd; border-radius: 10px; padding: 12px; box-sizing: border-box; resize: none; margin-bottom: 10px; font-size: 16px; }
        button { background: #1da1f2; color: white; border: none; padding: 12px; border-radius: 25px; cursor: pointer; font-weight: bold; width: 100%; font-size: 16px; }
        button:disabled { background: #ccc; }
        #status { margin-top: 15px; font-size: 0.9em; text-align: center; line-height: 1.6; }
        .settings { margin-top: 30px; font-size: 0.8em; color: #657786; border-top: 1px solid #e1e8ed; padding-top: 15px; }
        .input-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 4px; font-weight: bold; }
        input { width: 100%; padding: 10px; border: 1px solid #ccd6dd; border-radius: 6px; box-sizing: border-box; }
        .info-box { background: #f0f7ff; padding: 12px; border-radius: 8px; margin-top: 15px; border: 1px solid #cfe2ff; }
        .info-box a { color: #1da1f2; font-weight: bold; text-decoration: none; }
        .info-box a:hover { text-decoration: underline; }
    </style>
</head>
<body>

<div class="card">
    <h2>ã„ã¾ã©ã†ã—ã¦ã‚‹ï¼Ÿ</h2>
    <textarea id="tweetText" placeholder="ã“ã“ã«å…¥åŠ›ã—ã¦ãƒ„ã‚¤ãƒ¼ãƒˆï¼"></textarea>
    <button id="postBtn" onclick="postTweet()">ãƒ„ã‚¤ãƒ¼ãƒˆã™ã‚‹</button>
    <p id="status"></p>

    <div class="settings">
        <h3>ğŸ”‘ APIè¨­å®š</h3>
        
        <div class="info-box" style="margin-bottom: 20px;">
            <strong>ğŸ—ï¸ ã‚­ãƒ¼ã®å–å¾—ãƒ»å†ç™ºè¡Œã¯ã“ã¡ã‚‰:</strong><br>
            <a href="https://developer.x.com/en/portal/dashboard" target="_blank">X Developer Portal (å…¬å¼)</a>
            <p style="margin: 5px 0 0; font-size: 0.85em; color: #d93025;">â€» console.x.ai (Grok) ã®ã‚­ãƒ¼ã¯ä½¿ãˆã¾ã›ã‚“ï¼</p>
        </div>

        <div class="input-group">
            <label>API Key (Consumer Key)</label>
            <input type="password" id="cKey">
        </div>
        <div class="input-group">
            <label>API Key Secret (Consumer Secret)</label>
            <input type="password" id="cSecret">
        </div>
        <div class="input-group">
            <label>Access Token</label>
            <input type="password" id="aToken">
        </div>
        <div class="input-group">
            <label>Access Token Secret</label>
            <input type="password" id="aSecret">
        </div>
        <button onclick="saveKeys()" style="background: #657786; margin-top: 5px;">è¨­å®šã‚’ä¿å­˜</button>
        
        <div class="info-box">
            <strong>âš ï¸ ã‚¹ãƒãƒ›ç”¨ãƒ»é€ä¿¡è¨±å¯:</strong><br>
            <a href="https://cors-anywhere.herokuapp.com/corsdemo" target="_blank">ã“ã“ã‚’1å›æŠ¼ã—ã¦ã€Œé’ã„ãƒœã‚¿ãƒ³ã€ã‚’ã‚¿ãƒƒãƒ—</a>
        </div>
    </div>
</div>

<script>
    // ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ãƒ»ç½²åãƒ»é€ä¿¡ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯å‰å›ã¨åŒã˜
    window.onload = () => {
        ['cKey', 'cSecret', 'aToken', 'aSecret'].forEach(id => {
            document.getElementById(id).value = localStorage.getItem('x_' + id) || '';
        });
    };

    function saveKeys() {
        ['cKey', 'cSecret', 'aToken', 'aSecret'].forEach(id => {
            localStorage.setItem('x_' + id, document.getElementById(id).value);
        });
        alert('ã‚­ãƒ¼ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã—ã¾ã—ãŸï¼');
    }

    function getAuthHeader(method, url, params) {
        const cKey = localStorage.getItem('x_cKey');
        const cSecret = localStorage.getItem('x_cSecret');
        const tKey = localStorage.getItem('x_aToken');
        const tSecret = localStorage.getItem('x_aSecret');
        if(!cKey || !cSecret || !tKey || !tSecret) return null;

        const oauthParams = {
            oauth_consumer_key: cKey,
            oauth_nonce: Math.random().toString(36).substring(2),
            oauth_signature_method: "HMAC-SHA1",
            oauth_timestamp: Math.floor(Date.now() / 1000),
            oauth_token: tKey,
            oauth_version: "1.0"
        };
        const allParams = { ...params, ...oauthParams };
        const baseString = method.toUpperCase() + "&" + encodeURIComponent(url) + "&" +
            encodeURIComponent(Object.keys(allParams).sort().map(k => `${encodeURIComponent(k)}=${encodeURIComponent(allParams[k])}`).join("&"));
        const signingKey = encodeURIComponent(cSecret) + "&" + encodeURIComponent(tSecret);
        const signature = CryptoJS.HmacSHA1(baseString, signingKey).toString(CryptoJS.enc.Base64);
        oauthParams.oauth_signature = signature;
        return "OAuth " + Object.keys(oauthParams).sort().map(k => `${k}="${encodeURIComponent(oauthParams[k])}"`).join(", ");
    }

    async function postTweet() {
        const text = document.getElementById('tweetText').value;
        const btn = document.getElementById('postBtn');
        const status = document.getElementById('status');
        if (!text) return alert('å…¥åŠ›ã—ã¦ã­');
        btn.disabled = true;
        status.innerHTML = 'â³ é€ä¿¡ä¸­...';

        const apiUrl = "https://api.twitter.com/2/tweets";
        const proxyUrl = "https://cors-anywhere.herokuapp.com/"; 
        const authHeader = getAuthHeader("POST", apiUrl, {});

        try {
            const response = await fetch(proxyUrl + apiUrl, {
                method: "POST",
                headers: { "Authorization": authHeader, "Content-Type": "application/json", "x-requested-with": "XMLHttpRequest" },
                body: JSON.stringify({ text: text })
            });
            const result = await response.json();
            if (response.ok) {
                const tweetUrl = `https://x.com/i/status/${result.data.id}`;
                status.innerHTML = `âœ… æˆåŠŸï¼<br><a href="${tweetUrl}" target="_blank">ãƒ„ã‚¤ãƒ¼ãƒˆã‚’è¦‹ã‚‹</a>`;
                document.getElementById('tweetText').value = "";
            } else {
                status.innerHTML = "âŒ ã‚¨ãƒ©ãƒ¼: " + (result.detail || "APIè¨­å®šã‚„æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„");
            }
        } catch (e) {
            status.innerHTML = "âŒ æ¥ç¶šå¤±æ•—ã€‚ãƒ—ãƒ­ã‚­ã‚·ã®è¨±å¯è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
        } finally {
            btn.disabled = false;
        }
    }
</script>
</body>
</html>
